<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiOlif FASHION</title>
    <link rel="shortcut icon" href="../assets/images/icon.png">
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <!-- Preloader -->
    <div class="preloader">
        <div class="loader"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="side-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <button type="button" class="sidebar-close-btn text-gray-500 hover-text-white hover-bg-main-600 text-md w-24 h-24 border border-gray-100 hover-border-main-600 d-xl-none d-flex flex-center rounded-circle position-absolute"><i class="ph ph-x"></i></button>
        <a href="../index.html" class="sidebar__logo text-center p-20 position-sticky inset-block-start-0 bg-white w-100 z-1 pb-10">
            <img src="../assets/images/logopanjang.png" alt="Logo" style="width: 100px; height: auto;">
        </a>
        <div class="sidebar-menu-wrapper overflow-y-auto scroll-sm">
            <div class="p-20 pt-10">
                <ul class="sidebar-menu">
                    <li class="sidebar-menu__item">
                        <a href="../index.html" class="sidebar-menu__link">
                            <span class="icon"><i class="ph ph-squares-four"></i></span>
                            <span class="text">Dashboard</span>
                        </a>
                    </li>
                    <li class="sidebar-menu__item">
                        <a href="/kelolapelanggan" class="sidebar-menu__link">
                            <span class="icon"><i class="ph ph-standard-definition"></i></span>
                            <span class="text">Kelola Pelanggan</span>
                        </a>
                    </li>
                    <li class="sidebar-menu__item">
                        <a href="/kelolatransaksi" class="sidebar-menu__link">
                            <span class="icon"><i class="ph ph-shopping-cart"></i></span>
                            <span class="text">Kelola Transaksi</span>
                        </a>
                    </li>
                    <li class="sidebar-menu__item">
                        <span class="text-gray-300 text-sm px-20 pt-20 fw-semibold border-top border-gray-100 d-block text-uppercase">Settings</span>
                    </li>
                    <li class="sidebar-menu__item">
                        <a href="setting.html" class="sidebar-menu__link">
                            <span class="icon"><i class="ph ph-gear"></i></span>
                            <span class="text">Account Settings</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="dashboard-main-wrapper">
        <div class="top-navbar flex-between gap-16">
            <div class="flex-align gap-16">
                <button type="button" class="toggle-btn d-xl-none d-flex text-26 text-gray-500"><i class="ph ph-list"></i></button>
                <form action="#" class="w-350 d-sm-block d-none">
                    <div class="position-relative">
                        <button type="submit" class="input-icon text-xl d-flex text-gray-100 pointer-event-none"><i class="ph ph-magnifying-glass"></i></button>
                        <input type="text" class="form-control ps-40 h-40 border-transparent focus-border-main-600 bg-main-50 rounded-pill placeholder-15" placeholder="Search...">
                    </div>
                </form>
            </div>
            <div class="flex-align gap-16">
                <div class="dropdown">
                    <button class="btn btn-outline-none text-gray-500 w-40 h-40 bg-main-50 rounded-circle text-xl flex-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="position-relative">
                            <i class="ph ph-bell"></i>
                            <span class="alarm-notify position-absolute end-0"></span>
                        </span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        <div class="card border-0 p-0">
                            <div class="card-body">
                                <p>No notifications available.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="users arrow-down-icon border border-gray-200 rounded-pill p-4 d-inline-block pe-40 position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="position-relative">
                            <img src="../assets/images/PP.png" alt="Image" class="h-32 w-32 rounded-circle">
                            <span class="activation-badge w-8 h-8 position-absolute inset-block-end-0 inset-inline-end-0"></span>
                        </span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        <div class="card border-0">
                            <div class="card-body">
                                <div class="flex-align gap-8 mb-20 pb-20 border-bottom border-gray-100">
                                    <img src="../assets/images/PP.png" alt="" class="w-54 h-54 rounded-circle">
                                    <div>
                                        <h4 class="mb-0">Melly R</h4>
                                        <p class="fw-medium text-13 text-gray-200">mellyr@mail.com</p>
                                    </div>
                                </div>
                                <ul>
                                    <li class="mb-4">
                                        <a href="setting.html" class="py-12 text-15 px-20 hover-bg-gray-50 text-gray-300 rounded-8 flex-align gap-8 fw-medium text-15">
                                            <span class="text-2xl text-primary-600 d-flex"><i class="ph ph-gear"></i></span>
                                            <span class="text">Pengaturan</span>
                                        </a>
                                    </li>
                                    <li class="pt-8 border-top border-gray-100">
                                        <a href="/logout" class="py-12 text-15 px-20 hover-bg-danger-50 text-gray-300 hover-text-danger-600 rounded-8 flex-align gap-8 fw-medium text-15">
                                            <span class="text-2xl text-danger-600 d-flex"><i class="ph ph-sign-out"></i></span>
                                            <span class="text">Log Out</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-body">
            <div class="breadcrumb mb-24">
                <ul class="flex-align gap-4">
                    <li><a href="../index.html" class="text-gray-600 fw-normal text-15 hover-text-main-600">Home</a></li>
                    <li><span class="text-gray-500 fw-normal d-flex"><i class="ph ph-caret-right"></i></span></li>
                    <li><span class="text-main-600 fw-normal text-15">Detail Pelanggan</span></li>
                </ul>
            </div>

            <div class="card overflow-hidden">
                <div class="card-body p-0">
                    <div class="cover-img position-relative">
                        <div class="avatar-upload">
                            <input type="file" id="coverImageUpload" accept=".png, .jpg, .jpeg">
                            <div class="avatar-preview">
                                <div id="coverImagePreview" style="background-image: url('../assets/images/ppsekolah.png');"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-profile px-24">
                        <div class="flex-between">
                            <div class="d-flex align-items-end flex-wrap mb-32 gap-24">
                                <a href="#" class="btn btn-outline-main py-2 px-4 position-absolute top-0 end-0 mt-48 me-24">Edit Pelanggan</a>
                                <img src="../assets/images/ppsekolah.png" alt="" class="w-120 h-120 rounded-circle border border-white">
                                <div>
                                    <h4 class="mb-8" id="customerName"></h4>
                                    <div class="setting-profile__infos flex-align flex-wrap gap-16">
                                        <div class="flex-align gap-6">
                                            <span class="text-gray-600 d-flex text-lg"><i class="ph ph-phone"></i></span>
                                            <span class="text-gray-600 text-15" id="customerContact"></span>
                                        </div>
                                        <div class="flex-align gap-6">
                                            <span class="text-gray-600 d-flex text-lg"><i class="ph ph-map-pin"></i></span>
                                            <span class="text-gray-600 text-15" id="customerAddress"></span>
                                        </div>
                                        <div class="flex-align gap-6">
                                            <span class="text-gray-600 d-flex text-lg"><i class="ph ph-calendar-dots"></i></span>
                                            <span class="text-gray-600 text-15" id="customerCreated"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <ul class="nav nav-pills common-tab style-two mb-0" id="pills-tab">
                            <li class="nav-item">
                                <button class="nav-link active" id="pills-daftar-tab" data-bs-toggle="pill" data-bs-target="#pills-daftar-seragam" type="button" role="tab">Harga Seragam</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="pills-billing-tab" data-bs-toggle="pill" data-bs-target="#pills-billing" type="button" role="tab">Pembelian</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Perbaiki bagian tab content untuk menambahkan tab Pembelian -->
<div class="tab-content" id="pills-tabContent">
    <!-- Daftar Seragam -->
    <div class="tab-pane fade show active" id="pills-daftar-seragam" role="tabpanel">
        <div class="card mt-24">
            <div class="card-header border-bottom">
                <div class="flex-between flex-wrap gap-16">
                    <div>
                        <h4 class="mb-4">Daftar Seragam</h4>
                    </div>
                    <div class="flex-align flex-wrap justify-content-end gap-8">
                        <button type="button" class="btn btn-primary rounded-pill py-2" data-bs-toggle="modal" data-bs-target="#tambahSeragamModal">
                            + Tambah Seragam
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-30 overflow-x-auto">
                <table id="uniformTable" class="table table-bordered table-striped text-center">
                    <thead>
                        <tr>
                            <th class="h6 text-sm text-muted text-center">No</th>
                            <th class="h6 text-sm text-muted text-center">Nama Seragam</th>
                            <th class="h6 text-sm text-muted text-center">Ukuran</th>
                            <th class="h6 text-sm text-muted text-center">Harga</th>
                            <th class="h6 text-sm text-muted text-center">Catatan</th>
                            <th class="h6 text-sm text-muted text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="uniformBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAMBAHAN: Tab Pembelian -->
    <div class="tab-pane fade" id="pills-billing" role="tabpanel">
        <div class="card mt-24">
            <div class="card-header border-bottom">
                <div class="flex-between flex-wrap gap-16">
                    <div>
                        <h4 class="mb-4">Riwayat Pembelian</h4>
                        <p class="text-muted text-sm mb-0">Semua transaksi pembelian seragam</p>
                    </div>
                    <div class="flex-align flex-wrap justify-content-end gap-8">
                        <!-- Filter Status -->
                        <select id="statusFilter" class="form-select w-auto">
                            <option value="">Semua Status</option>
                            <option value="paid">Lunas</option>
                            <option value="pending">Pending</option>
                            <option value="cancelled">Dibatalkan</option>
                        </select>
                        
                        <!-- Add New Transaction -->
                        <a href="/formpesanan" class="btn btn-primary rounded-pill py-2">
                            + Buat Pesanan Baru
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body p-30 overflow-x-auto">
                <table id="transactionTable" class="table table-bordered table-striped text-center">
                    <thead>
                        <tr>
                            <th class="h6 text-sm text-muted text-center">No</th>
                            <th class="h6 text-sm text-muted text-center">ID Transaksi</th>
                            <th class="h6 text-sm text-muted text-center">Tanggal Order</th>
                            <th class="h6 text-sm text-muted text-center">Jenis Pesanan</th>
                            <th class="h6 text-sm text-muted text-center">Jumlah Item</th>
                            <th class="h6 text-sm text-muted text-center">Total Harga</th>
                            <th class="h6 text-sm text-muted text-center">Status</th>
                            <th class="h6 text-sm text-muted text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionBody">
                        <!-- Data akan dimuat secara dinamis -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        <!-- Modal Tambah Seragam -->
<div class="modal fade" id="tambahSeragamModal" tabindex="-1" aria-labelledby="tambahSeragamModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content rounded-4">
                    <div class="modal-header">
                        <h4 class="modal-title" id="tambahSeragamModalLabel">Tambah Seragam</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formTambahSeragam">
                            <div class="mb-3">
                                <label for="uniformName" class="form-label">Nama Seragam <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="uniformName" name="uniform_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="size" class="form-label">Ukuran <span class="text-danger">*</span></label>
                                <select class="form-select" id="size" name="size" required>
                                    <option value="" disabled selected>Pilih Ukuran</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="price" class="form-label">Harga <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="price" name="price" min="0" step="1000" required>
                            </div>
                            <div class="mb-3">
                                <label for="notes" class="form-label">Catatan</label>
                                <input type="text" class="form-control" id="notes" name="notes">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" form="formTambahSeragam" class="btn btn-primary">Simpan</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Edit Seragam -->
        <div class="modal fade" id="editSeragamModal" tabindex="-1" aria-labelledby="editSeragamModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content rounded-4">
                    <div class="modal-header">
                        <h4 class="modal-title" id="editSeragamModalLabel">Edit Seragam</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formEditSeragam">
                            <input type="hidden" id="editUniformId" name="id">
                            <div class="mb-3">
                                <label for="editUniformName" class="form-label">Nama Seragam <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editUniformName" name="uniform_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="editSize" class="form-label">Ukuran <span class="text-danger">*</span></label>
                                <select class="form-select" id="editSize" name="size" required>
                                    <option value="" disabled>Pilih Ukuran</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editPrice" class="form-label">Harga <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editPrice" name="price" min="0" step="1000" required>
                            </div>
                            <div class="mb-3">
                                <label for="editNotes" class="form-label">Catatan</label>
                                <input type="text" class="form-control" id="editNotes" name="notes">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-danger" id="btnHapusSeragam">Hapus</button>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" form="formEditSeragam" class="btn btn-primary">Update</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Riwayat Harga -->
        <div class="modal fade" id="riwayatHargaModal" tabindex="-1" aria-labelledby="riwayatHargaModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content rounded-4">
                    <div class="modal-header">
                        <h4 class="modal-title" id="riwayatHargaModalLabel">Riwayat Harga</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped text-center">
                                <thead>
                                    <tr>
                                        <th class="h6 text-sm text-muted text-center">No</th>
                                        <th class="h6 text-sm text-muted text-center">Harga Lama</th>
                                        <th class="h6 text-sm text-muted text-center">Tanggal Perubahan</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="../assets/js/jquery-3.7.1.min.js"></script>
        <script src="../assets/js/boostrap.bundle.min.js"></script>
        <script src="../assets/js/phosphor-icon.js"></script>
        <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
        <script src="../assets/js/main.js"></script>

        <script>
            let currentCustomerId = null;
            let currentUniformId = null;

            document.addEventListener('DOMContentLoaded', function() {
                // Ambil ID customer dari URL
                currentCustomerId = window.location.pathname.split('/').pop();
                
                // Initialize DataTable
                $('#uniformTable').DataTable({
                    searching: false,
                    paging: true,
                    info: false,
                    ordering: true
                });

                // Setup tab event listeners
                setupTabListeners();
                
                // Setup status filter
                setupStatusFilter();

                // Load data customer dan uniforms
                loadCustomerData();
                loadCustomerUniforms();
                
                // Setup event listeners
                setupEventListeners();
            });

            // Setup tab listeners
function setupTabListeners() {
    const billingTab = document.getElementById('pills-billing-tab');
    if (billingTab) {
        billingTab.addEventListener('click', function() {
            // Load transactions when tab is clicked
            setTimeout(() => {
                loadCustomerTransactions();
            }, 100);
        });
    }
}

// Setup status filter
function setupStatusFilter() {
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            loadCustomerTransactions(this.value);
        });
    }
}

// Di detailpelanggan.html, pastikan JavaScript sudah benar
// Perbaiki function loadCustomerTransactions
function loadCustomerTransactions(statusFilter = '') {
    console.log('Loading transactions for customer:', currentCustomerId, 'with status filter:', statusFilter);
    
    let url = '/api/customers/' + currentCustomerId + '/transactions';
    
    // Add status filter if provided
    if (statusFilter) {
        url += '?status=' + encodeURIComponent(statusFilter);
    }
    
    console.log('Fetching from URL:', url);
    
    fetch(url)
        .then(res => {
            console.log('Response status:', res.status);
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            return res.json();
        })
        .then(transactions => {
            console.log('Received transactions:', transactions);
            displayTransactions(transactions);
        })
        .catch(error => {
            console.error('Error loading transactions:', error);
            showAlert('Gagal memuat data transaksi: ' + error.message, 'warning');
            
            // Display empty state with error
            const tbody = document.getElementById('transactionBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <div class="py-3">
                                <i class="ph ph-warning text-warning" style="font-size: 3rem;"></i>
                                <p class="mt-2 mb-1">Gagal memuat data transaksi</p>
                                <small class="text-muted">${error.message}</small>
                                <br>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadCustomerTransactions()">
                                    <i class="ph ph-arrow-clockwise me-1"></i>Coba Lagi
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        });
}

function displayTransactions(transactions) {
    const tbody = document.getElementById('transactionBody');
    if (!tbody) {
        console.error('Transaction table body not found');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <div class="py-3">
                        <i class="ph ph-shopping-cart text-gray-400" style="font-size: 3rem;"></i>
                        <p class="mt-2 mb-1">Belum ada transaksi</p>
                        <small class="text-muted">Pelanggan ini belum pernah melakukan pembelian</small>
                        <br>
                        <a href="/formpesanan" class="btn btn-primary btn-sm mt-2 rounded-pill">
                            <i class="ph ph-plus me-1"></i>Buat Pesanan Pertama
                        </a>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    transactions.forEach((transaction, index) => {
        const statusInfo = getTransactionStatusInfo(transaction.status);
        const transactionType = determineTransactionType(transaction);
        
        const row = `
            <tr>
                <td class="text-center">
                    <span class="h6 mb-0 fw-medium text-muted">${index + 1}</span>
                </td>
                <td class="text-center">
                    <span class="h6 mb-0 fw-medium text-primary-600">#${transaction.id}</span>
                </td>
                <td class="text-center">
                    <span class="h6 mb-0 fw-medium text-muted">${formatTransactionDate(transaction.transaction_date)}</span>
                </td>
                <td class="text-center">
                    <span class="text-11 py-1 px-2 rounded-pill ${transactionType.class}">${transactionType.text}</span>
                </td>
                <td class="text-center">
                    <span class="h6 mb-0 fw-medium text-muted">${transaction.item_count || 0} item</span>
                </td>
                <td class="text-center">
                    <span class="h6 mb-0 fw-medium text-muted">Rp ${formatCurrency(transaction.total_price)}</span>
                </td>
                <td class="text-center">
                    <span class="text-11 py-1 px-2 rounded-pill ${statusInfo.class}">
                        <span class="w-6 h-6 ${statusInfo.dotClass} rounded-circle d-inline-block me-1"></span>
                        ${statusInfo.text}
                    </span>
                </td>
                <td class="text-center">
                    <div class="d-flex gap-1 justify-content-center">
                        <button 
                            type="button"
                            onclick="viewTransactionDetail(${transaction.id}, ${transaction.has_student_info || false})"
                            class="bg-primary-50 text-primary-600 py-1 px-2 rounded-pill hover-bg-primary-600 hover-text-white d-inline-flex align-items-center gap-1 border-0"
                            title="Lihat detail">
                            <i class="ph ph-eye text-12"></i>
                            <span class="text-11">Detail</span>
                        </button>
                        <button 
                            type="button"
                            onclick="previewKuitansiCustomer(${transaction.id}, ${transaction.has_student_info || false})"
                            class="bg-success-50 text-success-600 py-1 px-2 rounded-pill hover-bg-success-600 hover-text-white d-inline-flex align-items-center gap-1 border-0"
                            title="Preview dan Print Kuitansi">
                            <i class="ph ph-printer text-12"></i>
                            <span class="text-11">Print</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
    
    console.log('Transactions displayed:', transactions.length);
}

// Function untuk preview kuitansi dari detail customer
function previewKuitansiCustomer(transactionId, hasStudentInfo) {
    console.log('Preview kuitansi for transaction:', transactionId, 'hasStudentInfo:', hasStudentInfo);
    
    let printUrl;
    
    if (hasStudentInfo === true || hasStudentInfo === 'true') {
        // Untuk transaksi student order
        printUrl = `/api/transactions/${transactionId}/print-kuitansi`;
    } else {
        // Untuk transaksi normal/item order
        printUrl = `/api/transactions/${transactionId}/print-kuitansi-biasa`;
    }
    
    console.log('Opening print URL:', printUrl);
    
    // Buka PDF di tab baru untuk preview
    window.open(printUrl, '_blank');
}

// Get transaction status info
function getTransactionStatusInfo(status) {
    const statusMap = {
        'paid': {
            text: 'Lunas',
            class: 'bg-success-50 text-success-600',
            dotClass: 'bg-success-600'
        },
        'pending': {
            text: 'Pending',
            class: 'bg-warning-50 text-warning-700',
            dotClass: 'bg-warning-600'
        },
        'cancelled': {
            text: 'Dibatalkan',
            class: 'bg-danger-50 text-danger-600',
            dotClass: 'bg-danger-600'
        }
    };
    
    return statusMap[status] || {
        text: status || 'Unknown',
        class: 'bg-gray-50 text-gray-600',
        dotClass: 'bg-gray-600'
    };
}

// Determine transaction type
function determineTransactionType(transaction) {
    if (transaction.has_student_info) {
        return {
            type: 'student',
            text: 'Per Anak',
            class: 'bg-info-50 text-info-600'
        };
    } else {
        return {
            type: 'item',
            text: 'Per Item',
            class: 'bg-secondary-50 text-secondary-600'
        };
    }
}

// Perbaiki function viewTransactionDetail untuk mengarah ke URL yang benar
function viewTransactionDetail(transactionId, hasStudentInfo) {
    console.log('Viewing transaction detail:', transactionId, 'has student info:', hasStudentInfo);
    
    let detailUrl;
    
    if (hasStudentInfo) {
        // Redirect ke detail pesanan student dengan format query parameter
        detailUrl = `http://localhost:8080/detailpesanan?id=${transactionId}`;
    } else {
        // Redirect ke detail pesanan per item dengan format query parameter
        detailUrl = `http://localhost:8080/detailpesananperitem?id=${transactionId}`;
    }
    
    console.log('Redirecting to:', detailUrl);
    window.location.href = detailUrl;
}

// Format transaction date
function formatTransactionDate(dateString) {
    if (!dateString) return 'Tidak diketahui';
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
    });
}

// Format currency (reuse existing function or add if not exists)
function formatCurrency(amount) {
    if (!amount || amount === 0) return '0';
    return parseInt(amount).toLocaleString('id-ID');
}

            // Load data customer
            function loadCustomerData() {
                fetch('/api/customers/' + currentCustomerId)
                    .then(res => {
                        if (!res.ok) throw new Error('Customer tidak ditemukan');
                        return res.json();
                    })
                    .then(customer => {
                        document.getElementById('customerName').textContent = customer.name || 'Tidak diketahui';
                        document.getElementById('customerContact').textContent = customer.contact || 'Tidak ada kontak';
                        document.getElementById('customerAddress').textContent = customer.address || 'Tidak ada alamat';
                        document.getElementById('customerCreated').textContent = formatDate(customer.created_at);
                        document.title = 'Detail ' + customer.name + ' - DiOlif FASHION';
                    })
                    .catch(error => {
                        console.error('Error loading customer:', error);
                        showAlert('Gagal memuat data pelanggan', 'danger');
                    });
            }

            // Load daftar seragam customer
            function loadCustomerUniforms() {
                fetch('/api/customers/' + currentCustomerId + '/uniforms')
                    .then(res => {
                        if (!res.ok) throw new Error('Gagal memuat seragam');
                        return res.json();
                    })
                    .then(uniforms => {
                        displayUniforms(uniforms);
                    })
                    .catch(error => {
                        console.error('Error loading uniforms:', error);
                        showAlert('Gagal memuat data seragam', 'danger');
                    });
            }

            // Display uniforms dalam tabel
            function displayUniforms(uniforms) {
                const tbody = document.getElementById('uniformBody');
                tbody.innerHTML = '';
                
                if (uniforms.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                Tidak ada data seragam. Klik tombol "Tambah Seragam" untuk menambah.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                uniforms.forEach((uniform, index) => {
                    const row = `
                        <tr>
                            <td class="text-center">
                                <span class="h6 mb-0 fw-medium text-muted">${index + 1}</span>
                            </td>
                            <td class="text-center">
                                <span class="h6 mb-0 fw-medium text-muted">${uniform.uniform_name}</span>
                            </td>
                            <td class="text-center">
                                <span class="h6 mb-0 fw-medium text-muted">${uniform.size}</span>
                            </td>
                            <td class="text-center">
                                <span class="h6 mb-0 fw-medium text-muted">Rp ${parseInt(uniform.price).toLocaleString('id-ID')}</span>
                            </td>
                            <td class="text-center">
                                <span class="h6 mb-0 fw-medium text-muted">${uniform.notes || '-'}</span>
                            </td>
                            <td class="text-center">
                                <button 
                                    type="button"
                                    onclick="editUniform(${uniform.id})"
                                    class="bg-primary-50 text-primary-600 py-2 px-14 rounded-pill hover-bg-primary-600 hover-text-white d-inline-flex align-items-center gap-2 border-0 me-2">
                                    <i class="ph ph-pencil-simple"></i>
                                    Edit
                                </button>
                                <button 
                                    type="button"
                                    onclick="showPriceHistory(${uniform.id}, '${uniform.uniform_name}', '${uniform.size}')"
                                    class="bg-warning-50 text-warning-700 py-2 px-14 rounded-pill hover-bg-warning-600 hover-text-white d-inline-flex align-items-center gap-2 border-0">
                                    <i class="ph ph-clock-counter-clockwise"></i>
                                    Riwayat Harga
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            // Setup event listeners
            function setupEventListeners() {
                // Form tambah seragam
                document.getElementById('formTambahSeragam').addEventListener('submit', function(e) {
                    e.preventDefault();
                    addUniform();
                });
                
                // Form edit seragam
                document.getElementById('formEditSeragam').addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateUniform();
                });
                
                // Button hapus seragam
                document.getElementById('btnHapusSeragam').addEventListener('click', function() {
                    if (currentUniformId) {
                        deleteUniform(currentUniformId);
                    }
                });
            }

            // Tambah seragam baru (fokus add seragam per customer ID)
            function addUniform() {
                const form = document.getElementById('formTambahSeragam');
                const formData = new FormData(form);
                
                const data = {
                    uniform_name: formData.get('uniform_name').trim(),
                    size: formData.get('size').trim(),
                    price: parseFloat(formData.get('price')),
                    notes: formData.get('notes') ? formData.get('notes').trim() : ''
                };
                
                // Validasi input
                if (!data.uniform_name || !data.size || isNaN(data.price) || data.price <= 0) {
                    showAlert('Semua field wajib diisi dengan benar!', 'danger');
                    return;
                }

                // Validasi duplikasi seragam-ukuran
                const existingUniforms = Array.from(document.querySelectorAll('#uniformBody tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        return {
                            name: cells[1].textContent.trim().toLowerCase(),
                            size: cells[2].textContent.trim().toLowerCase()
                        };
                    }
                    return null;
                }).filter(u => u !== null);

                const isDuplicate = existingUniforms.some(u => 
                    u.name === data.uniform_name.toLowerCase() && 
                    u.size === data.size.toLowerCase()
                );

                if (isDuplicate) {
                    showAlert(`Ukuran "${data.size}" untuk seragam "${data.uniform_name}" sudah ada!`, 'warning');
                    return;
                }
                
                // Kirim data ke API
                fetch('/api/customers/' + currentCustomerId + '/uniforms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(async response => {
                    if (response.ok) {
                        showAlert('Seragam berhasil ditambahkan!', 'success');
                        form.reset();
                        bootstrap.Modal.getInstance(document.getElementById('tambahSeragamModal')).hide();
                        loadCustomerUniforms(); // Reload data
                    } else {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Gagal menambahkan seragam');
                    }
                })
                .catch(error => {
                    console.error('Error adding uniform:', error);
                    showAlert('Gagal menambahkan seragam: ' + error.message, 'danger');
                });
            }

            // Edit seragam (fokus edit per uniform ID)
            function editUniform(uniformId) {
                currentUniformId = uniformId;
                
                // Fetch data seragam berdasarkan ID
                fetch('/api/customer-uniforms/' + uniformId)
                    .then(res => {
                        if (!res.ok) throw new Error('Data tidak ditemukan');
                        return res.json();
                    })
                    .then(uniform => {
                        // Isi form edit dengan data yang ada
                        document.getElementById('editUniformId').value = uniform.id;
                        document.getElementById('editUniformName').value = uniform.uniform_name;
                        document.getElementById('editSize').value = uniform.size;
                        document.getElementById('editPrice').value = uniform.price;
                        document.getElementById('editNotes').value = uniform.notes || '';
                        
                        // Tampilkan modal edit
                        bootstrap.Modal.getOrCreateInstance(document.getElementById('editSeragamModal')).show();
                    })
                    .catch(error => {
                        console.error('Error loading uniform:', error);
                        showAlert('Gagal memuat data seragam: ' + error.message, 'danger');
                    });
            }

            // Update seragam
            function updateUniform() {
                const form = document.getElementById('formEditSeragam');
                const formData = new FormData(form);
                
                const data = {
                    uniform_name: formData.get('uniform_name').trim(),
                    size: formData.get('size').trim(),
                    price: parseFloat(formData.get('price')),
                    notes: formData.get('notes') ? formData.get('notes').trim() : ''
                };
                
                // Validasi input
                if (!data.uniform_name || !data.size || isNaN(data.price) || data.price <= 0) {
                    showAlert('Semua field wajib diisi dengan benar!', 'danger');
                    return;
                }
                
                // Update data via API
                fetch('/api/customer-uniforms/' + currentUniformId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(async response => {
                    if (response.ok) {
                        showAlert('Seragam berhasil diupdate!', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('editSeragamModal')).hide();
                        loadCustomerUniforms(); // Reload data
                    } else {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Gagal mengupdate seragam');
                    }
                })
                .catch(error => {
                    console.error('Error updating uniform:', error);
                    showAlert('Gagal mengupdate seragam: ' + error.message, 'danger');
                });
            }

            // Hapus seragam
            function deleteUniform(uniformId) {
                if (!confirm('Yakin ingin menghapus seragam ini?')) return;
                
                fetch('/api/customer-uniforms/' + uniformId, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            showAlert('Seragam berhasil dihapus!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editSeragamModal')).hide();
                            loadCustomerUniforms(); // Reload data
                        } else {
                            throw new Error('Gagal menghapus seragam');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting uniform:', error);
                        showAlert('Gagal menghapus seragam: ' + error.message, 'danger');
                    });
            }

            // Show price history (riwayat harga per uniform ID dengan modal)
            function showPriceHistory(uniformId, uniformName, size) {
                // Set judul modal
                document.getElementById('riwayatHargaModalLabel').textContent = `Riwayat Harga: ${uniformName} (${size})`;
                
                // Fetch riwayat harga berdasarkan uniform ID
                fetch('/api/customer-uniforms/' + uniformId + '/price-history')
                    .then(res => {
                        if (!res.ok) throw new Error('Gagal memuat riwayat harga');
                        return res.json();
                    })
                    .then(data => {
                        const tbody = document.getElementById('historyBody');
                        tbody.innerHTML = '';
                        
                        if (!data || data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Belum ada riwayat perubahan harga.</td></tr>';
                        } else {
                            // Tampilkan data riwayat harga
                            tbody.innerHTML = data.map((h, i) => `
                                <tr>
                                    <td class="text-center">
                                        <span class="h6 mb-0 fw-medium text-muted">${i + 1}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="h6 mb-0 fw-medium text-muted">Rp ${Number(h.OldPrice).toLocaleString('id-ID')}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="h6 mb-0 fw-medium text-muted">
                                            ${h.ChangedAt ? h.ChangedAt.replace('T', ' ').substring(0, 19) : '-'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('');
                        }
                        
                        // Tampilkan modal riwayat harga
                        bootstrap.Modal.getOrCreateInstance(document.getElementById('riwayatHargaModal')).show();
                    })
                    .catch(error => {
                        console.error('Error loading price history:', error);
                        showAlert('Gagal memuat riwayat harga: ' + error.message, 'danger');
                    });
            }

            // Utility functions
            function formatDate(dateString) {
                if (!dateString) return 'Tidak diketahui';
                const date = new Date(dateString);
                return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            function showAlert(message, type) {
                const existingAlerts = document.querySelectorAll('.alert-custom');
                existingAlerts.forEach(alert => alert.remove());
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed alert-custom`;
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => alertDiv.remove(), 5000);
            }
        </script>
    </body>
</html>