<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title -->
    <title> DiOlif FASHION</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="assets/images/icon.png">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <!-- file upload -->
    <link rel="stylesheet" href="assets/css/file-upload.css">
    <!-- file upload -->
    <link rel="stylesheet" href="assets/css/plyr.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <!-- full calendar -->
    <link rel="stylesheet" href="assets/css/full-calendar.css">
    <!-- jquery Ui -->
    <link rel="stylesheet" href="assets/css/jquery-ui.css">
    <!-- editor quill Ui -->
    <link rel="stylesheet" href="assets/css/editor-quill.css">
    <!-- apex charts Css -->
    <link rel="stylesheet" href="assets/css/apexcharts.css">
    <!-- calendar Css -->
    <link rel="stylesheet" href="assets/css/calendar.css">
    <!-- jvector map Css -->
    <link rel="stylesheet" href="assets/css/jquery-jvectormap-2.0.5.css">
    <!-- Main css -->
    <link rel="stylesheet" href="assets/css/main.css">
</head> 
<body>
    
<!--==================== Preloader Start ====================-->
  <div class="preloader">
    <div class="loader"></div>
  </div>
<!--==================== Preloader End ====================-->

<!--==================== Sidebar Overlay End ====================-->
<div class="side-overlay"></div>
<!--==================== Sidebar Overlay End ====================-->

    <!-- ============================ Sidebar Start ============================ -->
<aside class="sidebar">
    <!-- sidebar close btn -->
     <button type="button" class="sidebar-close-btn text-gray-500 hover-text-white hover-bg-main-600 text-md w-24 h-24 border border-gray-100 hover-border-main-600 d-xl-none d-flex flex-center rounded-circle position-absolute"><i class="ph ph-x"></i></button>
    <!-- sidebar close btn -->
    
     <a href="index.html" class="sidebar__logo text-center p-20 position-sticky inset-block-start-0 bg-white w-100 z-1 pb-10">
    <img src="assets/images/logopanjang.png" alt="Logo" style="width: 100px; height: auto;">
</a>

    <div class="sidebar-menu-wrapper overflow-y-auto scroll-sm">
        <div class="p-20 pt-10">
            <ul class="sidebar-menu">
                <li class="sidebar-menu__item">
                    <a href="/dashboard" class="sidebar-menu__link">
                        <span class="icon"><i class="ph ph-squares-four" ></i></span>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-menu__item">
                    <a href="/kelolapelanggan" class="sidebar-menu__link">
                        <span class="icon"><i class="ph ph-standard-definition" ></i></span>
                        <span class="text">Kelola Pelanggan</span>
                    </a>
                </li> 
                <li class="sidebar-menu__item">
                    <a href="/kelolatransaksi" class="sidebar-menu__link">
                        <span class="icon"><i class="ph ph-shopping-cart"></i></span>
                        <span class="text">Kelola Transaksi</span>
                    </a>
                </li>
                <li class="sidebar-menu__item">
                    <span class="text-gray-300 text-sm px-20 pt-20 fw-semibold border-top border-gray-100 d-block text-uppercase">Settings</span>
                </li>
                
                <li class="sidebar-menu__item">
                    <a href="setting.html" class="sidebar-menu__link">
                        <span class="icon"><i class="ph ph-gear"></i></span>
                        <span class="text">Account Settings</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</aside>    
<!-- ============================ Sidebar End  ============================ -->

    <div class="dashboard-main-wrapper">
        <div class="top-navbar flex-between gap-16">
    <div class="flex-align gap-16">
        <!-- Toggle Button Start -->
         <button type="button" class="toggle-btn d-xl-none d-flex text-26 text-gray-500"><i class="ph ph-list"></i></button>
        <!-- Toggle Button End -->
        
        <form action="#" class="w-350 d-sm-block d-none">
            <div class="position-relative">
                <button type="submit" class="input-icon text-xl d-flex text-gray-100 pointer-event-none"><i class="ph ph-magnifying-glass"></i></button> 
                <input type="text" class="form-control ps-40 h-40 border-transparent focus-border-main-600 bg-main-50 rounded-pill placeholder-15" placeholder="Search...">
            </div>
        </form>
    </div>

    <div class="flex-align gap-16">
        <div class="flex-align gap-8">
            <!-- Notification Start -->
            <div class="dropdown">
                <button class="dropdown-btn shaking-animation text-gray-500 w-40 h-40 bg-main-50 hover-bg-main-100 transition-2 rounded-circle text-xl flex-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="position-relative">
                        <i class="ph ph-bell"></i>
                        <span class="alarm-notify position-absolute end-0"></span>
                    </span>
                </button>
            </div>
            <!-- Notification End -->
        </div>

        <!-- User Profile Start -->
        <div class="dropdown">
            <button class="users arrow-down-icon border border-gray-200 rounded-pill p-4 d-inline-block pe-40 position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="position-relative">
                    <img src="assets/images/PP.png" alt="Image" class="h-32 w-32 rounded-circle">
                    <span class="activation-badge w-8 h-8 position-absolute inset-block-end-0 inset-inline-end-0"></span>
                </span>
            </button>
        </div>
        <!-- User Profile End -->
    </div>
</div>

<div class="dashboard-body">
    <!-- Breadcrumb Start -->
    <div class="breadcrumb mb-24">
        <ul class="flex-align gap-4">
            <li><a href="index.html" class="text-gray-200 fw-normal text-15 hover-text-main-600">Home</a></li>
            <li> <span class="text-gray-500 fw-normal d-flex"><i class="ph ph-caret-right"></i></span> </li>
            <li><span class="text-main-600 fw-normal text-15">Kelola Pelanggan</span></li>
        </ul>
    </div>
    <!-- Breadcrumb End -->

    <!-- Course Tab Start -->
    <div class="card">
        <div class="card-body">
            <div class="mb-24 flex-between gap-16 flex-wrap-reverse">
                <ul class="nav nav-pills common-tab gap-20" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="pills-semua-tab" data-filter="semua" type="button">Semua (0)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-paud-tab" data-filter="PAUD" type="button">PAUD (0)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-tk-tab" data-filter="TK" type="button">TK (0)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-sd-tab" data-filter="SD" type="button">SD (0)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-smp-tab" data-filter="SMP" type="button">SMP (0)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-tpq-tab" data-filter="TPQ" type="button">TPQ (0)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-lainnya-tab" data-filter="Lainnya" type="button">Lainnya (0)</button>
                    </li>
                </ul>
                <a href="/tambahpelanggan" class="btn btn-main rounded-pill py-7 flex-align gap-4 fw-normal">
                    <span class="d-flex text-md"><i class="ph ph-plus"></i></span> 
                    Tambah Pelanggan
                </a>
            </div>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-content" role="tabpanel">
                    <div class="row g-20" id="customerContainer">
                        <!-- Customer cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Course Tab End -->
</div>
        
        
        <!-- Footer -->
         <div class="dashboard-footer">
            <div class="flex-between flex-wrap gap-16">
                <p class="text-gray-300 text-13 fw-normal"> &copy; Copyright diOlif 2025, All Rights Reserved</p>
                <div class="flex-align flex-wrap gap-16">
                    <a href="#" class="text-gray-300 text-13 fw-normal hover-text-main-600 hover-text-decoration-underline">License</a>
                    <a href="#" class="text-gray-300 text-13 fw-normal hover-text-main-600 hover-text-decoration-underline">More Themes</a>
                    <a href="#" class="text-gray-300 text-13 fw-normal hover-text-main-600 hover-text-decoration-underline">Documentation</a>
                    <a href="#" class="text-gray-300 text-13 fw-normal hover-text-main-600 hover-text-decoration-underline">Support</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Jquery js -->
    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap Bundle Js -->
    <script src="assets/js/boostrap.bundle.min.js"></script>
    <!-- Phosphor Js -->
    <script src="assets/js/phosphor-icon.js"></script>
    <!-- file upload -->
    <script src="assets/js/file-upload.js"></script>
    <!-- file upload -->
    <script src="assets/js/plyr.js"></script>
    <!-- dataTables -->
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <!-- full calendar -->
    <script src="assets/js/full-calendar.js"></script>
    <!-- jQuery UI -->
    <script src="assets/js/jquery-ui.js"></script>
    <!-- jQuery UI -->
    <script src="assets/js/editor-quill.js"></script>
    <!-- apex charts -->
    <script src="assets/js/apexcharts.min.js"></script>
    <!-- Calendar Js -->
    <script src="assets/js/calendar.js"></script>
    <!-- jvectormap Js -->
    <script src="assets/js/jquery-jvectormap-2.0.5.min.js"></script>
    <!-- jvectormap world Js -->
    <script src="assets/js/jquery-jvectormap-world-mill-en.js"></script>
    
    <!-- main js -->
    <script src="assets/js/main.js"></script>

    <script>
let allCustomers = []; // Store all customers data
let currentFilter = 'semua'; // Track current active filter

document.addEventListener('DOMContentLoaded', function() {
    loadCustomers();
    setupTabFilters();
    setupSearch();
});

// Load semua customers dari API
function loadCustomers() {
    fetch('/api/customers')
        .then(res => {
            if (!res.ok) throw new Error('Failed to fetch customers');
            return res.json();
        })
        .then(customers => {
            allCustomers = customers; // Store data globally
            updateTabCounts(customers);
            displayCustomers(customers, currentFilter);
        })
        .catch(err => {
            console.error('Error loading customers:', err);
            showAlert('Gagal memuat data pelanggan: ' + err.message, 'danger');
        });
}

// Display customers dalam card format berdasarkan filter
function displayCustomers(customers, filterType) {
    const container = document.getElementById('customerContainer');
    if (!container) return;
    
    // Filter customers berdasarkan tipe
    let filteredCustomers = customers;
    if (filterType && filterType !== 'semua') {
        filteredCustomers = customers.filter(c => {
            if (filterType === 'Lainnya') {
                // Lainnya adalah semua yang bukan PAUD, TK, SD, SMP, TPQ
                return !['PAUD', 'TK', 'SD', 'SMP', 'TPQ'].includes(c.type.toUpperCase());
            }
            return c.type.toUpperCase() === filterType.toUpperCase();
        });
    }
    
    container.innerHTML = '';
    
    if (filteredCustomers.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="ph ph-users text-gray-300" style="font-size: 4rem;"></i>
                    </div>
                    <h5 class="text-gray-500 mb-2">Tidak ada pelanggan ditemukan</h5>
                    <p class="text-gray-400 text-sm">
                        ${filterType === 'semua' ? 'Belum ada data pelanggan.' : `Tidak ada pelanggan dengan tipe "${filterType}".`}
                    </p>
                    ${filterType === 'semua' ? 
                        '<a href="/tambahpelanggan" class="btn btn-main rounded-pill py-2 px-3 mt-3"><i class="ph ph-plus me-2"></i>Tambah Pelanggan Pertama</a>' : 
                        ''
                    }
                </div>
            </div>
        `;
        return;
    }
    
    filteredCustomers.forEach(customer => {
        const cardHtml = `
            <div class="col-xxl-3 col-lg-67 col-sm-10">
                <div class="card border border-gray-100 h-100">
                    <div class="card-body p-0">
                        <div class="bg-main-100 rounded-top-8 overflow-hidden text-center h-120 flex-center p-3">
                            <img src="assets/images/banner.png" alt="Customer Image" class="img-fluid" style="max-height: 80px;">
                        </div>
                        <div class="p-3">
                            <div class="mb-2">
                                <span class="text-11 py-1 px-2 rounded-pill bg-success-50 text-success-600 fw-medium">${customer.type}</span>
                            </div>
                            <h6 class="mb-2 fw-semibold">
                                <a href="/detailpelanggan/${customer.id}" class="hover-text-main-600 text-decoration-none">${customer.name}</a>
                            </h6>
                            
                            <div class="mb-3">
                                <p class="text-gray-600 text-12 mb-1 d-flex align-items-center">
                                    <i class="ph ph-phone me-2 text-14"></i>
                                    <span class="text-truncate">${customer.contact || 'Tidak ada kontak'}</span>
                                </p>
                                <p class="text-gray-600 text-12 mb-0 d-flex align-items-start">
                                    <i class="ph ph-map-pin me-2 text-14 mt-1"></i>
                                    <span class="text-truncate" title="${customer.address || 'Tidak ada alamat'}">${customer.address || 'Tidak ada alamat'}</span>
                                </p>
                            </div>
                            
                            <div class="mb-3">
                                <span class="text-gray-500 text-11">Dibuat ${formatDate(customer.created_at)}</span>
                            </div>
                            
                            <div class="d-flex gap-2 flex-wrap">
                                <button onclick="detailPelanggan(${customer.id})" class="btn btn-outline-main rounded-pill py-1 px-2 text-11 flex-fill">
                                    <i class="ph ph-eye me-1"></i>Detail
                                </button>
                                <button onclick="editCustomer(${customer.id})" class="btn btn-outline-warning rounded-pill py-1 px-2 text-11">
                                    <i class="ph ph-pencil"></i>
                                </button>
                                <button onclick="deleteCustomer(${customer.id})" class="btn btn-outline-danger rounded-pill py-1 px-2 text-11">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += cardHtml;
    });
}

// Setup tab filters dengan event listener yang benar
function setupTabFilters() {
    const tabs = document.querySelectorAll('.nav-pills .nav-link[data-filter]');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Get filter type from data-filter attribute
            const filterType = this.getAttribute('data-filter');
            currentFilter = filterType;
            
            // Apply filter
            displayCustomers(allCustomers, filterType);
            
            console.log('Filter applied:', filterType); // Debug log
        });
    });
}

// Update tab counts berdasarkan data customers
function updateTabCounts(customers) {
    const counts = {
        semua: customers.length,
        PAUD: customers.filter(c => c.type.toUpperCase() === 'PAUD').length,
        TK: customers.filter(c => c.type.toUpperCase() === 'TK').length,
        SD: customers.filter(c => c.type.toUpperCase() === 'SD').length,
        SMP: customers.filter(c => c.type.toUpperCase() === 'SMP').length,
        TPQ: customers.filter(c => c.type.toUpperCase() === 'TPQ').length,
        Lainnya: customers.filter(c => !['PAUD', 'TK', 'SD', 'SMP', 'TPQ'].includes(c.type.toUpperCase())).length
    };
    
    // Update tab text dengan count
    document.getElementById('pills-semua-tab').textContent = `Semua (${counts.semua})`;
    document.getElementById('pills-paud-tab').textContent = `PAUD (${counts.PAUD})`;
    document.getElementById('pills-tk-tab').textContent = `TK (${counts.TK})`;
    document.getElementById('pills-sd-tab').textContent = `SD (${counts.SD})`;
    document.getElementById('pills-smp-tab').textContent = `SMP (${counts.SMP})`;
    document.getElementById('pills-tpq-tab').textContent = `TPQ (${counts.TPQ})`;
    document.getElementById('pills-lainnya-tab').textContent = `Lainnya (${counts.Lainnya})`;
    
    console.log('Tab counts updated:', counts); // Debug log
}

// Fungsi untuk format tanggal
function formatDate(dateString) {
    if (!dateString) return 'Tidak diketahui';
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
    });
}

// Fungsi navigasi ke halaman detail pelanggan
function detailPelanggan(id) {
    window.location.href = '/detailpelanggan/' + id;
}

// Fungsi navigasi ke halaman edit customer
function editCustomer(id) {
    window.location.href = '/edit-customer/' + id;
}

// Fungsi hapus customer
function deleteCustomer(id) {
    if (!confirm('Yakin ingin menghapus pelanggan ini? Data seragam dan transaksi terkait juga akan terhapus.')) {
        return;
    }
    
    fetch('/api/customers/' + id, { 
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(res => {
        if (res.ok) {
            showAlert('Pelanggan berhasil dihapus', 'success');
            loadCustomers(); // Reload data
        } else {
            throw new Error('Gagal menghapus pelanggan');
        }
    })
    .catch(err => {
        console.error('Error deleting customer:', err);
        showAlert('Gagal menghapus pelanggan: ' + err.message, 'danger');
    });
}

// Search functionality
function setupSearch() {
    const searchInput = document.querySelector('input[placeholder="Search..."]');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            // Filter dari allCustomers berdasarkan search term
            const searchResults = allCustomers.filter(c => 
                c.name.toLowerCase().includes(searchTerm) ||
                c.type.toLowerCase().includes(searchTerm) ||
                (c.contact && c.contact.toLowerCase().includes(searchTerm)) ||
                (c.address && c.address.toLowerCase().includes(searchTerm))
            );
            
            // Apply current filter to search results
            displayCustomers(searchResults, currentFilter);
        });
    }
}

// Alert system
function showAlert(message, type) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-custom');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed alert-custom`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
    </script>
    
    </body>
</html>