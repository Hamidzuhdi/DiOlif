<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Tambah Student Order</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 40px; }
    .form-container { background: #fff; padding: 30px; border-radius: 8px; max-width: 900px; margin: auto; box-shadow: 0 1px 4px rgba(0,0,0,0.1);}
    table { width: 100%; border-collapse: collapse; margin-bottom: 18px; background: #fff; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; }
    th { background: #2979ff; color: #fff; }
    .btn { padding: 6px 14px; border-radius: 4px; border: none; cursor: pointer; }
    .btn-add { background: #2979ff; color: #fff; }
    .btn-del { background: #ff4d4f; color: #fff; }
    .siswa-row { background: #f7f7f7; }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Tambah Student Order</h2>
    <form id="studentOrderForm">
      <div>
        <label>Pilih Sekolah/Customer:</label>
        <select id="customer_id" name="customer_id" required>
          <option value="">Pilih Customer</option>
        </select>
      </div>
      <div>
        <label>Tanggal Transaksi:</label>
        <input type="date" id="transaction_date" name="transaction_date" required>
      </div>
      <div>
        <label>Tanggal Pembayaran:</label>
        <input type="date" id="payment_date" name="payment_date">
      </div>
      <div>
        <label>Status:</label>
        <select id="status" name="status" required>
          <option value="pending">Pending</option>
          <option value="paid">Paid</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div>
        <label>Catatan:</label>
        <textarea id="notes" name="notes" rows="2"></textarea>
      </div>
      <h3>Daftar Siswa & Item</h3>
      <table id="siswaTable">
        <thead>
          <tr>
            <th>Nama Siswa</th>
            <th>Kelas</th>
            <th>Seragam</th>
            <th>Ukuran</th>
            <th>Harga</th>
            <th>Jumlah</th>
            <th>Catatan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="siswaBody"></tbody>
      </table>
      <button type="button" class="btn btn-add" onclick="addSiswaRow()">Tambah Siswa</button>
      <button type="submit" class="btn btn-add">Simpan Student Order</button>
      <a href="/repeat-order" style="margin-left:10px;">Kembali</a>
    </form>
    <div id="responseMessage" style="margin-top:15px;"></div>
  </div>
<script>
let customerUniforms = [];
let customers = [];

async function loadCustomers() {
  const response = await fetch('/api/customers');
  customers = await response.json();
  const select = document.getElementById('customer_id');
  select.innerHTML = '<option value="">Pilih Customer</option>';
  customers.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    select.appendChild(opt);
  });
}

async function loadCustomerUniforms(customerId) {
  if (!customerId) return;
  const response = await fetch(`/api/customers/${customerId}/uniforms`);
  customerUniforms = await response.json();
  document.getElementById('siswaBody').innerHTML = '';
}

document.addEventListener('DOMContentLoaded', () => {
  loadCustomers();
  document.getElementById('customer_id').addEventListener('change', function() {
    loadCustomerUniforms(this.value);
  });
});

function addSiswaRow() {
  if (!customerUniforms || customerUniforms.length === 0) {
    alert('Silakan pilih customer dan tunggu data seragam dimuat terlebih dahulu');
    return;
  }
  const tr = document.createElement('tr');
  tr.className = 'siswa-row';
  tr.innerHTML = `
    <td><input type="text" class="student_name" required></td>
    <td><input type="text" class="grade" required></td>
    <td>
      <div class="seragam-list"></div>
    </td>
    <td>
      <div class="ukuran-list"></div>
    </td>
    <td>
      <div class="harga-list"></div>
    </td>
    <td>
      <div class="jumlah-list"></div>
    </td>
    <td>
      <div class="catatan-list"></div>
    </td>
    <td><button type="button" class="btn btn-del" onclick="this.closest('tr').remove()">Hapus</button></td>
  `;
  document.getElementById('siswaBody').appendChild(tr);

  const seragamDiv = tr.querySelector('.seragam-list');
  const ukuranDiv = tr.querySelector('.ukuran-list');
  const hargaDiv = tr.querySelector('.harga-list');
  const jumlahDiv = tr.querySelector('.jumlah-list');
  const catatanDiv = tr.querySelector('.catatan-list');

  // Group uniforms by name to avoid duplicates
  const uniformGroups = {};
  customerUniforms.forEach(u => {
    if (!uniformGroups[u.uniform_name]) {
      uniformGroups[u.uniform_name] = {
        name: u.uniform_name,
        sizes: []
      };
    }
    uniformGroups[u.uniform_name].sizes.push(u.size);
  });

  Object.values(uniformGroups).forEach((group, idx) => {
    seragamDiv.innerHTML += `<div>${group.name}</div>`;
    let sizeOptions = '<option value="">None</option>';
    group.sizes.forEach(size => {
      sizeOptions += `<option value="${size}">${size}</option>`;
    });
    ukuranDiv.innerHTML += `
      <div>
        <select class="ukuran-seragam" data-uniform="${group.name}" data-idx="${idx}" style="width:70px;">
          ${sizeOptions}
        </select>
      </div>
    `;
    hargaDiv.innerHTML += `
      <div>
        <input type="number" class="harga-seragam" data-uniform="${group.name}" data-idx="${idx}" value="0" readonly style="width:80px;">
      </div>
    `;
    jumlahDiv.innerHTML += `
      <div>
        <input type="number" class="jumlah-seragam" data-uniform="${group.name}" data-idx="${idx}" value="0" min="0" style="width:50px;">
      </div>
    `;
    catatanDiv.innerHTML += `
      <div>
        <input type="text" class="catatan-seragam" data-uniform="${group.name}" data-idx="${idx}" style="width:80px;">
      </div>
    `;
  });

  tr.querySelectorAll('.ukuran-seragam').forEach(select => {
    select.addEventListener('change', function() {
      const uniformName = this.getAttribute('data-uniform');
      const size = this.value;
      const hargaInput = tr.querySelector(`.harga-seragam[data-uniform="${uniformName}"]`);
      const jumlahInput = tr.querySelector(`.jumlah-seragam[data-uniform="${uniformName}"]`);
      if (!size) {
        hargaInput.value = 0;
        jumlahInput.value = 0;
      } else {
        const uniform = customerUniforms.find(u => u.uniform_name === uniformName && u.size === size);
        if (uniform) {
          hargaInput.value = uniform.price;
          if (parseInt(jumlahInput.value) === 0) {
            jumlahInput.value = 1;
          }
        } else {
          hargaInput.value = 0;
          jumlahInput.value = 0;
        }
      }
    });
  });
}

document.getElementById('studentOrderForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const customer_id = document.getElementById('customer_id').value;
  if (!customer_id) {
    alert('Silakan pilih customer terlebih dahulu');
    return;
  }
  const siswaRows = Array.from(document.querySelectorAll('.siswa-row'));
  const items = [];
  for (const row of siswaRows) {
    const student_name = row.querySelector('.student_name').value;
    const grade = row.querySelector('.grade').value;
    if (!student_name || !grade) {
      alert('Nama siswa dan kelas harus diisi');
      return;
    }
    const uniformSelects = row.querySelectorAll('.ukuran-seragam');
    for (const select of uniformSelects) {
      const uniform_name = select.getAttribute('data-uniform');
      const size = select.value;
      const quantity = parseInt(row.querySelector(`.jumlah-seragam[data-uniform="${uniform_name}"]`).value) || 0;
      const unit_price = parseFloat(row.querySelector(`.harga-seragam[data-uniform="${uniform_name}"]`).value) || 0;
      const notes = row.querySelector(`.catatan-seragam[data-uniform="${uniform_name}"]`).value;
      if (size && quantity > 0 && unit_price > 0) {
        items.push({
          student_name,
          grade,
          uniform_name,
          size,
          quantity,
          unit_price,
          notes
        });
      }
    }
  }
  if (items.length === 0) {
    alert('Minimal 1 item seragam harus diisi');
    return;
  }
  const data = {
    customer_id: parseInt(customer_id),
    transaction_date: document.getElementById('transaction_date').value,
    payment_date: document.getElementById('payment_date').value,
    status: document.getElementById('status').value,
    notes: document.getElementById('notes').value,
    items
  };
  const response = await fetch('/api/transactions/student', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });
  const msg = document.getElementById('responseMessage');
  if (!response.ok) {
    const error = await response.text();
    msg.innerHTML = '<span style="color:red;">Gagal menyimpan: ' + error + '</span>';
    return;
  }
  msg.innerHTML = '<span style="color:green;">Student order berhasil disimpan!</span>';
  setTimeout(() => { window.location.href = '/repeat-order'; }, 1000);
});
</script>
</body>
</html>